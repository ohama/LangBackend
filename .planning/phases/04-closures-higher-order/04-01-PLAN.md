---
phase: 04-closures-higher-order
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tutorial/12-closures.md
autonomous: true

must_haves:
  truths:
    - "Reader understands closure theory (environment capture, free variables)"
    - "Reader can implement free variable analysis"
    - "Reader understands closure conversion transformation"
    - "Reader can compile closures with environment capture"
    - "Reader can create heap-allocated closure environments"
  artifacts:
    - path: "tutorial/12-closures.md"
      provides: "Complete closure compilation chapter"
      min_lines: 1500
      contains: ["free variable", "closure conversion", "GC_malloc", "environment"]
  key_links:
    - from: "AST Lambda expression"
      to: "MLIR func.func + environment struct"
      via: "Closure conversion transformation"
      pattern: "func.func.*env.*llvm.ptr"
    - from: "Closure creation"
      to: "GC_malloc"
      via: "Heap allocation for environment"
      pattern: "GC_malloc.*env"
---

<objective>
Write Chapter 12: Closures - covering closure theory, free variable analysis, closure conversion transformation, and environment heap allocation

Purpose: Establish fundamental closure compilation patterns that higher-order functions will build upon
Output: Complete tutorial chapter enabling readers to compile closures with captured variables (CLOS-01, CLOS-02, CLOS-05)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-closures-higher-order/04-RESEARCH.md
@.planning/phases/03-functions-recursion/03-02-SUMMARY.md
@.planning/phases/02-core-language-basics/02-04-SUMMARY.md
@tutorial/10-functions.md
@tutorial/11-recursion.md
@tutorial/09-memory-management.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Chapter 12 Part 1 - Closure Theory and Free Variable Analysis</name>
  <files>tutorial/12-closures.md</files>
  <action>
Create Chapter 12 covering the first half of closure compilation.

**Structure (~800 lines):**

1. **Introduction (100 lines)**
   - Closure definition: function + captured environment
   - Why closures matter in functional programming
   - Chapter goal: compile `fun x -> x + captured_var`
   - Prerequisites: Chapter 10-11 (functions), Chapter 09 (GC)

2. **Closure Theory (200 lines)**
   - Lexical scoping vs dynamic scoping
   - Free variables vs bound variables with examples
   - Environment capture semantics (value capture, not reference)
   - Closure as (function pointer, environment pointer) pair
   - Visual diagram of closure structure

3. **Free Variable Analysis (250 lines)**
   - Algorithm: set-based traversal with bound variable accumulator
   - F# implementation of freeVars function
   - Handle all expression cases: Var, Lambda, App, Let, Literal, If
   - Examples showing analysis of nested lambdas
   - Edge cases: shadowing, nested scopes

4. **Closure Conversion Overview (250 lines)**
   - Transformation concept: make implicit capture explicit
   - Before/after examples showing lambda to closure conversion
   - Environment parameter as first argument to closure body
   - Flat environment strategy (vs linked environments)
   - Why flat environments for FunLang (O(1) access, simpler)

**Writing style:**
- Korean plain style (~이다/~한다)
- Technical terms in English (closure, environment, free variable)
- Code blocks for F# and MLIR examples
- Diagrams using ASCII art
- Reference prior chapters for established patterns

**Requirements:**
- Contains "자유 변수" (free variable in Korean)
- Contains "환경" (environment in Korean)
- Contains "클로저" (closure in Korean)
- At least 5 MLIR IR examples
- At least 3 F# code snippets
  </action>
  <verify>
```bash
wc -l tutorial/12-closures.md  # Should be ~800+ lines
grep -c "자유 변수\|free variable" tutorial/12-closures.md  # Should be 5+
grep -c "freeVars" tutorial/12-closures.md  # Should be 3+
grep -c "```" tutorial/12-closures.md  # Should be 15+ (code blocks)
```
  </verify>
  <done>Chapter 12 part 1 complete with closure theory and free variable analysis algorithm</done>
</task>

<task type="auto">
  <name>Task 2: Write Chapter 12 Part 2 - Closure Compilation and Code Generation</name>
  <files>tutorial/12-closures.md</files>
  <action>
Complete Chapter 12 with closure compilation implementation.

**Structure (append ~700 lines):**

5. **AST Extension for Lambda (150 lines)**
   - Add Lambda case to Expr type: Lambda of string * Expr
   - Add Closure type: Closure of string * Expr * Environment
   - Parser updates (conceptual - reader has parser from LangTutorial)
   - Example AST for `fun x -> x + y`

6. **Environment Struct in MLIR (150 lines)**
   - Closure struct layout: [fn_ptr, var1, var2, ...]
   - LLVM struct type creation
   - Named constants for environment indices (ENV_FN_PTR = 0, ENV_FIRST_VAR = 1)
   - llvm.getelementptr for accessing slots
   - Helper functions: CreateClosureType, GetEnvSlot

7. **Closure Creation Code Generation (200 lines)**
   - compileLambda function:
     1. Analyze free variables
     2. Compute environment size
     3. GC_malloc for environment
     4. Store function pointer at env[0]
     5. Store captured variables at env[1+]
   - MLIR IR examples showing generated code
   - Complete F# implementation

8. **Closure Body Compilation (150 lines)**
   - Lifted function with environment parameter
   - Loading captured variables from environment
   - llvm.load from getelementptr
   - Environment parameter type: !llvm.ptr
   - Function naming convention: @lambda_N

9. **Common Errors (50 lines)**
   - Error 1: Environment index off-by-one (fn ptr at [0])
   - Error 2: Forgetting environment parameter
   - Error 3: Stack vs heap allocation
   - Error 4: Type mismatches in function pointer

**Code examples must include:**
- Complete compileLambda F# function
- MLIR IR for simple closure: `fun x -> x + captured`
- MLIR IR for nested closure: `fun x -> fun y -> x + y`
- Environment struct creation and access
- GC_malloc call for environment allocation

**Requirements:**
- Contains "GC_malloc" (heap allocation)
- Contains "llvm.getelementptr" (environment access)
- Contains "llvm.store" (storing captured values)
- At least 8 MLIR IR examples total in chapter
- Common Errors section with 4 error types
  </action>
  <verify>
```bash
wc -l tutorial/12-closures.md  # Should be ~1500+ lines
grep -c "GC_malloc" tutorial/12-closures.md  # Should be 5+
grep -c "llvm.getelementptr" tutorial/12-closures.md  # Should be 5+
grep -c "compileLambda\|컴파일" tutorial/12-closures.md  # Should be 5+
grep -c "Error\|오류" tutorial/12-closures.md  # Should be 4+ (common errors)
```
  </verify>
  <done>Chapter 12 complete with closure compilation, code generation, and common errors</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Content verification:**
```bash
# Chapter length
wc -l tutorial/12-closures.md  # Expect 1500+ lines

# Core concepts present
grep -c "클로저\|closure" tutorial/12-closures.md  # Expect 20+
grep -c "환경\|environment" tutorial/12-closures.md  # Expect 15+
grep -c "자유 변수\|free variable" tutorial/12-closures.md  # Expect 10+
grep -c "GC_malloc" tutorial/12-closures.md  # Expect 5+

# Code examples
grep -c "```mlir\|```fsharp\|```" tutorial/12-closures.md  # Expect 20+
```

2. **Structure verification:**
```bash
# Section headers
grep "^##" tutorial/12-closures.md  # Should show all major sections
```

3. **Korean style verification:**
```bash
# Plain style (~이다/~한다)
grep -c "~이다\|~한다\|이다\.\|한다\." tutorial/12-closures.md  # Present
grep "입니다\|합니다" tutorial/12-closures.md  # Should NOT be present
```
</verification>

<success_criteria>
- [ ] Chapter 12 exists at tutorial/12-closures.md
- [ ] Chapter is 1500+ lines
- [ ] Contains closure theory section with lexical scoping explanation
- [ ] Contains free variable analysis algorithm in F#
- [ ] Contains closure conversion explanation with before/after examples
- [ ] Contains environment struct layout explanation
- [ ] Contains compileLambda implementation
- [ ] Contains GC_malloc integration for heap allocation
- [ ] Contains at least 8 MLIR IR examples
- [ ] Contains Common Errors section with 4 error types
- [ ] Uses Korean plain style (~이다/~한다)
- [ ] Technical terms in English
</success_criteria>

<output>
After completion, create `.planning/phases/04-closures-higher-order/04-01-SUMMARY.md`
</output>
